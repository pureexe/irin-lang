(function(){var e;e=function(){function e(e,t){var n,i;this.env.runtime=this.runtime(),i=this,n=!1,this.data.files.push(e),this.parse(e,function(e,r){return r&&(i.data.graph={next:r.graph},i.data.head=i.data.graph,i.data.global=r.variable,n||t()),e?(t(e),n=!0):void 0})}var t;return e.prototype.data={graph:[],head:[],global:{},files:[]},e.prototype.config={includeDepth:50},e.prototype.env={runtime:"node",node:{fs:""}},e.prototype.parse=function(e,t){return this.parseWorker(e,0,t)},e.prototype.parseWorker=function(e,t,n){var i;return t>this.config.includeDepth?(console.error("stack crash"),n({message:"File reading stack more than "+this.config.includeDepth+" time. Maybe it got forever loop.",file:this.data.files.pop()})):(i=this,this.readFile(e,function(e,r){return e?n(e):i.parseProcess(r.toString(),t,n)}))},e.prototype.parseProcess=function(e,n,i){var r,o,a,p,s;return e=this.removeComment(e),o=e.split("\n"),s={line:0,indent:0,pastIndent:0,readingHeader:!1,functionObject:{},currentFuncName:"",graph:[],variable:{},headerDepth:0,isAddtoFunction:!1},s.head=s.graph,p=this,a=[],(r=function(e,h){var d,l,u,f,c,g;if(e&&(s=a.pop(),p.data.files.pop(),i({message:e.message,file:p.data.files.pop(),line:s.line})),h){for(p.data.files.pop(),s=a.pop(),s.indent=0,s.head=s.graph;s.indent!==s.headerDepth;)s.indent++,s.head=s.head[s.head.length-1].next;s.head.push.apply(s.head,h.graph);for(u in h.variable)s.variable[u]||(s.variable[u]=h.variable[u]);for(u in h.functionObject)s.functionObject[u]?s.functionObject[u].push.apply(s.functionObject[u],h.functionObject[u]):s.functionObject[u]=h.functionObject[u];s.pastIndent=s.headerDepth}for(;s.line<o.length;)if(c=o[s.line],s.indent=p.countIndent(c),c.trim().indexOf("---")>-1){if(s.readingHeader)s.readingHeader=!1;else{if(0!==s.line)return void i({message:"Header must declare on top of file only.",file:p.data.files.pop(),line:s.line});if(0!==s.indent)return void i({message:"Header must have no indent.",file:p.data.files.pop(),line:s.line});s.headerDepth=s.indent,s.readingHeader=!0}s.line++}else{if(s.readingHeader&&c.indexOf("<-")>-1)for(g=c.split("<-"),f=g.length-1,l=0;f>l;)s.variable[g[l].trim()]=g[f].trim(),l++;if(c=c.trim(),t(c)||i({message:"Bracket is mismatch.",file:p.data.files.pop(),line:s.line}),"->"===c.substring(0,2)&&".irin"===c.substring(c.length-5,c.length))return s.line++,s.headerDepth=s.indent,a.push(s),d=c.trim().substring(2,c.length).trim(),p.data.files.push(d),void p.parseWorker(d,n+1,r);if("->"!==c.substring(0,2)){if(s.isAddtoFunction&&0===s.indent&&(s.isAddtoFunction=!1),s.indent===s.pastIndent)s.head.push({text:c,next:[]}),s.head.length>1&&0===s.head[s.head.length-2].next.length&&(s.head[s.head.length-2].next=s.head[s.head.length-1].next);else if(s.indent>s.pastIndent){for(s.pastIndent=s.indent;s.head[s.head.length-1].next.length;)s.head=s.head[s.head.length-1].next,s.indent++;s.head=s.head[s.head.length-1].next,s.head.push({text:c,next:[]})}else if(s.indent<s.pastIndent){for(s.isAddtoFunction?s.head=s.functionObject[s.currentFuncName]:s.head=s.graph,s.pastIndent=s.indent;s.indent!==s.pastIndent;)s.indent++,s.head=s.head[s.head.length-1].next;s.head.push({text:c,next:[]})}s.line++}else{if(c=c.substring(2,c.length),c=c.trim(),""===c&&i({message:"Topic must have name.",file:p.data.files.pop(),line:s.line}),0===s.indent){s.functionObject[c]||(s.functionObject[c]=[]),s.currentFuncName=c,s.isAddtoFunction=!0,s.head=s.functionObject[c],s.line++,s.pastIndent=p.countIndent(o[s.line]);continue}s.functionObject[c]||(s.functionObject[c]=[]),s.pastIndent===s.indent?s.head.push(s.functionObject[c]):s.indent>s.pastIndent&&(s.head[s.head.length-1].next=s.functionObject[c]),s.line++}}return i(void 0,{graph:s.graph,variable:s.variable,functionObject:s.functionObject})})()},e.prototype.countIndent=function(e){var t;return t=e.search(/\S/),t=-1===t?0:t},e.prototype.removeComment=function(e){var t,n,i,r,o,a;for(a=e.split("\n"),o=[],r=!1,t=0,n=a.length;n>t;t++)i=a[t],i.indexOf("###")>-1?r?(r=!1,i=i.substring(i.indexOf("###")+3,i.length)):(r=!0,i=i.substring(0,i.indexOf("###"))):i.indexOf("#")>-1&&(i=i.substring(0,i.indexOf("#"))),0!==i.trim().length&&(r||o.push(i));return o.join("\n")},e.prototype.toRegular=function(e){var t,n,i,r,o;for(e=this.mergeExpression(e),o="",e=e.replace(/\*/g,"(.+)"),t=0;t<e.length;)if("["===e[t]){for(n=0;"]"!==e[t+n];)n++;if(r=e.substring(t+1,t+n).split("|"),t+n<e.length&&" "===e[t+n+1]){for(i=0;i<r.length;)r[i]=r[i]+"(?:\\s|\\b)+",i++;n++}if(t>0&&" "===e[t-1]){for(o=o.trim(),i=0;i<r.length;)r[i]="(?:\\s|\\b)+"+r[i],i++;r.push("(?:\\b|\\s)+")}else r.unshift("");r=r.join("|"),r=r.replace(new RegExp(this.escape("(.+)"),"g"),"(?:.+)"),o+="(?:"+r+")",t+=n+1}else o+=e[t],t++;return"^"+o+"$"},e.prototype.escape=function(e){var t,n,i,r;for(r="\\.+*?[^]$(){}=!<>|:".split(""),n=0,i=r.length;i>n;n++)t=r[n],e=e.replace(new RegExp("\\"+t,"g"),"\\"+t);return e},e.prototype.match=function(e,t){var n,i;return n=new RegExp(this.toRegular(t),"i"),i=e.match(n),i?(i.shift(),i):void 0},e.prototype.mergeExpression=function(e,t){var n,i,r,o,a,p,s,h,d,l;for(i="",l=0,o=0,d=0,p=0;p<e.length;){if(r=e[p],"{"===r)0===l?(i="",o=p):i+="{",l++;else if("}"===r)if(l--,0===l){if(d=p,i=i.trim(),-1!==i.indexOf("}")&&(i=this.mergeExpression(i,t)),-1!==i.indexOf("?")||-1!==i.indexOf("<-")){if(-1!==i.indexOf("?")&&(i=this.inlineCondition(i)),-1!==i.indexOf("<-"))for(h=i.split("<-"),i="",s=h.length-1,n=this.compileOperator(h[s].trim()),p=0;s>p;)this.data.global[h[p].trim()]=n,p++}else i=isNaN(parseInt(i))?this.data.global[i]:t[parseInt(i)-1];a=e.slice(0,o)+i,p=a.length-1,e=a+e.slice(d+1)}else i+="}";else i+=r;p++}return e},t=function(e){var t,n,i,r,o;for(r=[],n=0,i=e.length;i>n;n++)if(t=e[n],("{"===t||"("===t||"["===t)&&r.push(t),"}"===t||")"===t||"]"===t){if(0===r.length)return!1;if(o=r.pop(),"}"===t&&"{"!==o)return!1;if("]"===t&&"["!==o)return!1;if(")"===t&&"("!==o)return!1}return r.length>0?!1:!0},e.prototype.inlineToConditionTree=function(e){var t,n,i,r,o,a,p;for(p={data:void 0,prev:void 0},i=p,t="",r=!1,o=0,a=e.length;a>o;o++)if(n=e[o],"?"===n)i.data=t,t="",i.left={data:void 0,prev:i},i=i.left;else if(":"===n){for(i.data=t,t="",i=i.prev;i.right;)i=i.prev;i.right={data:void 0,prev:i},i=i.right}else t+=n;return i.data=t,p},e.prototype.checkOperator=function(e){var t,n,i,r;for(r=["(",")","!","&&","||","==","!=",">=","<=",">","<","*","/","+","-"],t=0,n=r.length;n>t;t++)if(i=r[t],e===i)return!0;return!1},e.prototype.tokenizeOperator=function(e){var t,n,i,r,o,a,p,s,h,d,l,u;for(e=[e],n=[],i=[],l=["(",")","!","&&","||","==","!=",">=","<=",">","<","*","/","+","-"],r=0,o=l.length;o>r;r++){for(d=l[r],s=0,a=e.length;a>s;s++)if(u=e[s],u.indexOf(d)>-1){for(i=u.split(d),h=0,p=i.length;p>h;h++)t=i[h],""!==t&&n.push(t),n.push(d);n.pop()}else n.push(u);e=n,n=[]}return e},e.prototype.convertToRPN=function(e){var t,n,i,r,o,a;for(n=this.tokenizeOperator(e),a=[],o=[],i=0,r=n.length;r>i;i++)if(t=n[i],this.checkOperator(t))if(")"===t){for(;o.length>0&&"("!==o[o.length-1];)a.push(o.pop());o.pop()}else o.push(t);else a.push(t);for(;o.length>0;)a.push(o.pop());return a},e.prototype.compileOperator=function(e){var t,n,i,r,o,a,p;for(a=this.convertToRPN(e),i=[],r=0,o=a.length;o>r;r++)p=a[r],"!"===p?i.push(!i.pop()):"&&"===p?i.push(i.pop()&&i.pop()):"||"===p?i.push(i.pop()||i.pop()):"=="===p?i.push(i.pop()===i.pop()):"!="===p?i.push(i.pop()!==i.pop()):">="===p?i.push(i.pop()<=i.pop()):"<="===p?i.push(i.pop()>=i.pop()):">"===p?i.push(i.pop()<i.pop()):"<"===p?i.push(i.pop()>i.pop()):"*"===p?i.push(parseFloat(i.pop())*parseFloat(i.pop())):"/"===p?i.push(parseFloat(i.pop())/parseFloat(i.pop())):"-"===p?i.push(parseFloat(i.pop())-parseFloat(i.pop())):"+"===p?(t=i.pop(),n=i.pop(),isNaN(parseFloat(t))||isNaN(parseFloat(n))?i.push(t+n):i.push(parseFloat(t)+parseFloat(n))):i.push(p);return i[0]},e.prototype.conditionWorker=function(e){return e.left&&e.right?this.compileOperator(e.data)?this.conditionWorker(e.left):this.conditionWorker(e.right):e.data},e.prototype.inlineCondition=function(e){var t;return t=this.inlineToConditionTree(e),this.conditionWorker(t)},e.prototype.selectChild=function(e,t){var n,i,r,o,a,p;for(this.text=e,this.head=t,a=this.head.next,r=0,o=a.length;o>r;r++)if(i=a[r],n=this.match(this.text,i.text))return p=Math.floor(Math.random()*i.next.length),{node:i.next[p],data:n}},e.prototype.reply=function(e,t){var n;return this.text=e,n=this.selectChild(this.text,this.data.head),n?(this.data.head=n.node,this.mergeExpression(n.node.text,n.data)):(this.data.head=this.data.graph,n=this.selectChild(this.text,this.data.head),n?(this.data.head=n.node,this.mergeExpression(n.node.text,n.data)):"[Log:Error] answer not found")},e.prototype.readFile=function(e,t){var n;return"node"===this.env.runtime?this.env.node.fs.readFile(e,"utf8",function(e,n){return t(e,n)}):"browser"===this.env.runtime?(n=new XMLHttpRequest,n.onreadystatechange=function(){return 4===n.readyState&&200===n.status?t(void 0,n.responseText):4===n.readyState?t({message:"ENOENT: no such file or directory, open '"+e+"' "}):void 0},n.open("GET",e,!0),n.send()):void 0},e.prototype.runtime=function(){return"undefined"==typeof window&&"object"==typeof module?(this.env.node.fs=require("fs"),"node"):"browser"},e}(),"object"==typeof module&&module&&"object"==typeof module.exports?module.exports=e:(window.Irin=e,"function"==typeof define&&define.amd&&define("Irin",[],function(){return e}))}).call(this);